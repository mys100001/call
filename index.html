<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 æç®€ç½‘é¡µé€šè¯ç³»ç»Ÿ</title>
    <script src="unpkg.com"></script>
    <style>
        :root { --primary: #007AFF; --danger: #FF3B30; --success: #34C759; }
        body { font-family: -apple-system, sans-serif; background: #f4f4f9; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 320px; text-align: center; }
        .status-dot { height: 10px; width: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: var(--success); }
        .id-badge { background: #eef6ff; color: var(--primary); padding: 10px; border-radius: 8px; font-weight: bold; margin: 15px 0; border: 1px dashed var(--primary); word-break: break-all; cursor: pointer; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
        .call-btn { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .hangup-btn { background: var(--danger); color: white; display: none; width: 100%; }
        #timer { font-size: 12px; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“ VoIP</div>
    <div id="status-container"><span id="dot" class="status-dot"></span><span id="status">æ­£åœ¨è¿æ¥ç½‘ç»œ...</span></div>
    
    <div id="my-id-box">
        <div style="font-size: 12px; color: #666;">ä½ çš„é€šè¯ ID (ç‚¹å‡»å¤åˆ¶):</div>
        <div class="id-badge" id="my-id" onclick="copyId()">æ­£åœ¨è·å–...</div>
    </div>

    <input type="text" id="remote-id" placeholder="è¾“å…¥å¯¹æ–¹ ID">
    
    <button id="call-btn" class="call-btn" onclick="makeCall()">å‘¼å«</button>
    <button id="hangup-btn" class="hangup-btn" onclick="endCall()">æŒ‚æ–­</button>
    
    <div id="timer"></div>
    <audio id="remoteAudio" autoplay></audio>
</div>

<script>
    let peer = new Peer();
    let currentCall = null;
    let startTime;
    let timerInterval;

    // åˆå§‹åŒ–ï¼šè·å–è‡ªå·±çš„ ID
    peer.on('open', (id) => {
        document.getElementById('my-id').innerText = id;
        document.getElementById('status').innerText = "åœ¨çº¿ (å°±ç»ª)";
        document.getElementById('dot').classList.add('online');
    });

    // ç›‘å¬å‘¼å…¥é€šè¯
    peer.on('call', (call) => {
        const accept = confirm("æ”¶åˆ°æ¥ç”µï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ");
        if (accept) {
            getMediaStream((stream) => {
                call.answer(stream);
                handleCall(call);
            });
        }
    });

    // æ‹¨æ‰“ç”µè¯
    function makeCall() {
        const destId = document.getElementById('remote-id').value;
        if (!destId) return alert("è¯·è¾“å…¥å¯¹æ–¹ ID");
        
        getMediaStream((stream) => {
            const call = peer.call(destId, stream);
            document.getElementById('status').innerText = "æ­£åœ¨å‘¼å«...";
            handleCall(call);
        });
    }

    // å¤„ç†åª’ä½“æµ
    function handleCall(call) {
        currentCall = call;
        toggleUI(true);

        call.on('stream', (remoteStream) => {
            document.getElementById('remoteAudio').srcObject = remoteStream;
            document.getElementById('status').innerText = "é€šè¯ä¸­";
            startTimer();
        });

        call.on('close', () => stopCallUI());
        call.on('error', () => {
            alert("é€šè¯å‘ç”Ÿé”™è¯¯");
            stopCallUI();
        });
    }

    // è·å–éº¦å…‹é£æƒé™
    function getMediaStream(callback) {
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            .then(callback)
            .catch(err => alert("éº¦å…‹é£æˆæƒå¤±è´¥: " + err));
    }

    // æŒ‚æ–­é€»è¾‘
    function endCall() {
        if (currentCall) currentCall.close();
        stopCallUI();
    }

    function stopCallUI() {
        toggleUI(false);
        document.getElementById('status').innerText = "åœ¨çº¿ (å°±ç»ª)";
        clearInterval(timerInterval);
        document.getElementById('timer').innerText = "";
    }

    function toggleUI(isCalling) {
        document.getElementById('call-btn').style.display = isCalling ? 'none' : 'block';
        document.getElementById('hangup-btn').style.display = isCalling ? 'block' : 'none';
        document.getElementById('remote-id').disabled = isCalling;
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            let diff = Math.floor((Date.now() - startTime) / 1000);
            let m = Math.floor(diff / 60).toString().padStart(2, '0');
            let s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `é€šè¯æ—¶é•¿: ${m}:${s}`;
        }, 1000);
    }

    function copyId() {
        const id = document.getElementById('my-id').innerText;
        navigator.clipboard.writeText(id);
        alert("ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå‘é€ç»™æœ‹å‹å§ï¼");
    }
</script>
</body>
</html>
